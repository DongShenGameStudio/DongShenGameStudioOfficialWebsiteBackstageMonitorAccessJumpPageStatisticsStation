<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>HTML5 高精度定位 + 高德逆地理</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;padding:40px;font-family:Arial,Helvetica,sans-serif;background:#f2f2f2}
#box{max-width:600px;margin:auto;background:#fff;padding:30px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
h2{margin-top:0}
.ok{color:#080}
.err{color:#c00}
pre{background:#f7f7f7;padding:12px;border-radius:4px;white-space:pre-wrap;word-break:break-all}
</style>
</head>
<body>
<div id="box">
  <h2>HTML5 高精度定位 + 高德逆地理</h2>
  <p id="status">等待用户授权…</p>
  <pre id="result"></pre>
  <button onclick="getLocation()">重新定位</button>
</div>

<script>
/* ========== 配置（已填好你的 Key） ========== */
const GD_KEY = 'bf641fd1c5de3871c6a592f17724c643';
const GD_URL = loc => `https://restapi.amap.com/v3/geocode/regeo?location=${loc.lng},${loc.lat}&key=${GD_KEY}&radius=1000&extensions=base`;

/* ========== 主流程 ========== */
async function getLocation(){
  const status = document.getElementById('status');
  const result = document.getElementById('result');
  status.textContent = '正在获取高精度坐标…';
  result.textContent = '';

  if(!navigator.geolocation){
    status.innerHTML = '<span class="err">❌ 浏览器不支持 Geolocation</span>';
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async pos => {
      const {latitude:lat, longitude:lng, accuracy} = pos.coords;
      status.textContent = '已获取坐标，正在逆地理编码…';

      try{
        const addr = await reverseGeo({lat,lng});
        status.innerHTML = '<span class="ok">✅ 定位成功</span>';
        result.textContent =
          `1. 经纬度：${lat}, ${lng}（精度约 ${Math.round(accuracy)} 米）\n` +
          `2. 国家  ：${addr.country}\n` +
          `3. 省份  ：${addr.province}\n` +
          `4. 城市  ：${addr.city}\n` +
          `5. 区县  ：${addr.district}\n` +
          `6. 街道  ：${addr.street}\n` +
          `7. 运营商：${await getISP()}`;
      }catch(e){
        status.innerHTML = '<span class="err">❌ 逆地理编码失败</span>';
        result.textContent = e.message;
      }
    },
    err => {
      const map = {1:'用户拒绝授权',2:'无法获取位置',3:'超时'};
      status.innerHTML = '<span class="err">❌ 定位失败：' + (map[err.code] || err.message) + '</span>';
    },
    {enableHighAccuracy:true, timeout:10000, maximumAge:0}
  );
}

/* ========== 逆地理（高德 REST） ========== */
async function reverseGeo({lat,lng}){
  const res = await fetch(GD_URL({lat,lng}));
  const json = await res.json();
  if(json.status!=='1') throw new Error(json.info || '逆地理编码异常');
  const r = json.regeocode.addressComponent;
  return {
    country : r.country || '未知国家',
    province: r.province || '未知省份',
    city    : r.city || r.province || '未知城市',
    district: r.district || '未知区县',
    street  : (r.township || '') + (r.streetNumber ? ' ' + r.streetNumber : '') || '未知街道'
  };
}

/* ========== 复用 6 号 API 拿运营商 ========== */
async function getISP(){
  try{
    const res = await fetch('https://ipinfo.io/json');
    const data = await res.json();
    return data.org || '未知运营商';
  }catch{
    return '未知运营商';
  }
}

/* ========== 自动跑一次 ========== */
getLocation();
</script>
</body>
</html>